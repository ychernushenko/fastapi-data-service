<!DOCTYPE html>

<html lang="en" data-content_root="./">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Accessing Google Cloud IAP-Protected Cloud Run Service with curl &#8212; FastAPI-Data-Service  documentation</title>
    <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=d1102ebc" />
    <link rel="stylesheet" type="text/css" href="_static/basic.css?v=686e5160" />
    <link rel="stylesheet" type="text/css" href="_static/alabaster.css?v=27fed22d" />
    <script src="_static/documentation_options.js?v=5929fcd5"></script>
    <script src="_static/doctools.js?v=9bcbadda"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Swagger API Documentation" href="swagger.html" />
    <link rel="prev" title="app package" href="app.html" />
   
  <link rel="stylesheet" href="_static/custom.css" type="text/css" />
  

  
  

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="accessing-google-cloud-iap-protected-cloud-run-service-with-curl">
<h1>Accessing Google Cloud IAP-Protected Cloud Run Service with <cite>curl</cite><a class="headerlink" href="#accessing-google-cloud-iap-protected-cloud-run-service-with-curl" title="Link to this heading">¶</a></h1>
<p>This guide provides step-by-step instructions for configuring Google Cloud Identity-Aware Proxy (IAP) to secure a Cloud Run service, generating an access token, and submitting a request to the service using <cite>curl</cite>.</p>
<section id="prerequisites">
<h2>Prerequisites<a class="headerlink" href="#prerequisites" title="Link to this heading">¶</a></h2>
<ol class="arabic simple">
<li><p><strong>Google Cloud Project</strong> with a deployed Cloud Run service.</p></li>
<li><p><strong>Permissions</strong>:
- <strong>IAP-secured Web App User</strong> role for users who need access to the IAP-protected service.
- <strong>Viewer</strong> or higher permission on the project to configure IAP and OAuth credentials.</p></li>
<li><p><strong>Tools</strong>:
- <cite>Google Cloud SDK (gcloud)</cite> - See installation instructions: <a class="reference external" href="https://cloud.google.com/sdk/docs/install">https://cloud.google.com/sdk/docs/install</a>
- <cite>curl</cite> installed on your machine.</p></li>
</ol>
</section>
<section id="step-1-install-google-cloud-sdk-and-authenticate">
<h2>Step 1: Install Google Cloud SDK and Authenticate<a class="headerlink" href="#step-1-install-google-cloud-sdk-and-authenticate" title="Link to this heading">¶</a></h2>
<ol class="arabic">
<li><p><strong>Install the Google Cloud SDK</strong>:
Follow the installation guide for your OS: <cite>https://cloud.google.com/sdk/docs/install</cite></p></li>
<li><p><strong>Initialize and Authenticate</strong>:
After installation, run the following commands to initialize <cite>gcloud</cite> and authenticate:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>gcloud<span class="w"> </span>init
gcloud<span class="w"> </span>auth<span class="w"> </span>login
</pre></div>
</div>
</li>
</ol>
</section>
<section id="step-2-set-up-oauth-credentials-for-iap">
<h2>Step 2: Set Up OAuth Credentials for IAP<a class="headerlink" href="#step-2-set-up-oauth-credentials-for-iap" title="Link to this heading">¶</a></h2>
<ol class="arabic simple">
<li><p>Go to the <strong>Google Cloud Console</strong>.</p></li>
<li><p>Navigate to <strong>APIs &amp; Services &gt; Credentials</strong>.</p></li>
<li><p>Click <strong>Create Credentials</strong> &gt; <strong>OAuth 2.0 Client ID</strong>.</p></li>
<li><p>Choose <strong>Desktop App</strong> as the Application type.</p></li>
<li><p>Note the <strong>Client ID</strong> and <strong>Client Secret</strong>. You’ll need these to authenticate users for IAP.</p></li>
</ol>
</section>
<section id="step-3-grant-iap-secured-web-app-user-role">
<h2>Step 3: Grant IAP-secured Web App User Role<a class="headerlink" href="#step-3-grant-iap-secured-web-app-user-role" title="Link to this heading">¶</a></h2>
<ol class="arabic simple">
<li><p>In <strong>Google Cloud Console</strong>, go to <strong>IAM &amp; Admin &gt; IAM</strong>.</p></li>
<li><p>Locate the user who needs access to the Cloud Run service.</p></li>
<li><p>Assign the <strong>IAP-secured Web App User</strong> role to the user for your Cloud Run service.</p></li>
</ol>
</section>
<section id="step-4-enable-iap-on-the-cloud-run-service">
<h2>Step 4: Enable IAP on the Cloud Run Service<a class="headerlink" href="#step-4-enable-iap-on-the-cloud-run-service" title="Link to this heading">¶</a></h2>
<ol class="arabic simple">
<li><p>Go to <strong>Security &gt; Identity-Aware Proxy</strong> in the Google Cloud Console.</p></li>
<li><p>Find your Cloud Run service and <strong>Enable IAP</strong> for it.</p></li>
</ol>
</section>
<section id="step-5-generate-an-identity-token">
<h2>Step 5: Generate an Identity Token<a class="headerlink" href="#step-5-generate-an-identity-token" title="Link to this heading">¶</a></h2>
<p>To access the IAP-protected service, generate an identity token using <cite>gcloud</cite>:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">ACCESS_TOKEN</span><span class="o">=</span><span class="k">$(</span>gcloud<span class="w"> </span>auth<span class="w"> </span>print-identity-token<span class="k">)</span>
</pre></div>
</div>
<p>This command retrieves a JWT identity token that can be used to access IAP-protected services.</p>
</section>
<section id="step-6-submit-a-request-with-curl">
<h2>Step 6: Submit a Request with <cite>curl</cite><a class="headerlink" href="#step-6-submit-a-request-with-curl" title="Link to this heading">¶</a></h2>
<p>Use <cite>curl</cite> to send a request to the IAP-protected Cloud Run service. Replace <cite>&lt;YOUR_CLOUD_RUN_URL&gt;</cite> with the URL of your Cloud Run service.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>curl<span class="w"> </span>-X<span class="w"> </span>POST<span class="w"> </span>&lt;YOUR_CLOUD_RUN_URL&gt;/data/<span class="w"> </span><span class="se">\</span>
<span class="w">     </span>-H<span class="w"> </span><span class="s2">&quot;Authorization: Bearer </span><span class="nv">$ACCESS_TOKEN</span><span class="s2">&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">     </span>-H<span class="w"> </span><span class="s2">&quot;Content-Type: application/json&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">     </span>-d<span class="w"> </span><span class="s1">&#39;{</span>
<span class="s1">           &quot;time_stamp&quot;: &quot;2019-05-01T06:00:00-04:00&quot;,</span>
<span class="s1">           &quot;data&quot;: [0.379, 1.589, 2.188]</span>
<span class="s1">         }&#39;</span>
</pre></div>
</div>
<p><strong>Example Command</strong>:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>curl<span class="w"> </span>-X<span class="w"> </span>POST<span class="w"> </span>https://fastapi-service-1093935530204.europe-west3.run.app/data/<span class="w"> </span><span class="se">\</span>
<span class="w">     </span>-H<span class="w"> </span><span class="s2">&quot;Authorization: Bearer </span><span class="nv">$ACCESS_TOKEN</span><span class="s2">&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">     </span>-H<span class="w"> </span><span class="s2">&quot;Content-Type: application/json&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">     </span>-d<span class="w"> </span><span class="s1">&#39;{</span>
<span class="s1">           &quot;time_stamp&quot;: &quot;2019-05-01T06:00:00-04:00&quot;,</span>
<span class="s1">           &quot;data&quot;: [0.379, 1.589, 2.188]</span>
<span class="s1">         }&#39;</span>
</pre></div>
</div>
</section>
<section id="troubleshooting">
<h2>Troubleshooting<a class="headerlink" href="#troubleshooting" title="Link to this heading">¶</a></h2>
<ul class="simple">
<li><p><strong>401 Unauthorized</strong>: Ensure the identity token is generated using <cite>gcloud auth print-identity-token</cite> and that IAP is enabled on the Cloud Run service.</p></li>
<li><p><strong>403 Forbidden</strong>: Check that the user has the <cite>IAP-secured Web App User</cite> role for the Cloud Run service.</p></li>
</ul>
</section>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="index.html">FastAPI-Data-Service</a></h1>









<search id="searchbox" style="display: none" role="search">
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" placeholder="Search"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script><h3>Navigation</h3>
<p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="modules.html">app</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Accessing Google Cloud IAP-Protected Cloud Run Service with <cite>curl</cite></a><ul>
<li class="toctree-l2"><a class="reference internal" href="#prerequisites">Prerequisites</a></li>
<li class="toctree-l2"><a class="reference internal" href="#step-1-install-google-cloud-sdk-and-authenticate">Step 1: Install Google Cloud SDK and Authenticate</a></li>
<li class="toctree-l2"><a class="reference internal" href="#step-2-set-up-oauth-credentials-for-iap">Step 2: Set Up OAuth Credentials for IAP</a></li>
<li class="toctree-l2"><a class="reference internal" href="#step-3-grant-iap-secured-web-app-user-role">Step 3: Grant IAP-secured Web App User Role</a></li>
<li class="toctree-l2"><a class="reference internal" href="#step-4-enable-iap-on-the-cloud-run-service">Step 4: Enable IAP on the Cloud Run Service</a></li>
<li class="toctree-l2"><a class="reference internal" href="#step-5-generate-an-identity-token">Step 5: Generate an Identity Token</a></li>
<li class="toctree-l2"><a class="reference internal" href="#step-6-submit-a-request-with-curl">Step 6: Submit a Request with <cite>curl</cite></a></li>
<li class="toctree-l2"><a class="reference internal" href="#troubleshooting">Troubleshooting</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="swagger.html">Swagger API Documentation</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="index.html">Documentation overview</a><ul>
      <li>Previous: <a href="app.html" title="previous chapter">app package</a></li>
      <li>Next: <a href="swagger.html" title="next chapter">Swagger API Documentation</a></li>
  </ul></li>
</ul>
</div>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &#169;2024, Yuri Chernushenko.
      
      |
      Powered by <a href="https://www.sphinx-doc.org/">Sphinx 8.1.3</a>
      &amp; <a href="https://alabaster.readthedocs.io">Alabaster 1.0.0</a>
      
      |
      <a href="_sources/curl_guide.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>